apiVersion: batch/v1
kind: Job
metadata:
  name: "${name}-dash-install-manifests"
spec:
  template:
    spec:
      serviceAccountName: $serviceAccount
      restartPolicy: Never
      containers:
      - name: init
        image: $kubectlImage
        command: ["/bin/sh", "-c"]
        args:
          - |
            # fail at first command that fails
            set -e
            # patch with application UID and create resources
            # don't validate due to: https://github.com/jetstack/cert-manager/issues/1143
            APP_UID=$(kubectl get applications.app.k8s.io ${name} -o jsonpath --template '{.metadata.uid}') ;
            echo "\n++ Patching resources with owner reference: $name ($APP_UID)" ;

            cat /data/globals/manifest_globals.yaml | env -i "APPLICATION_UID=$APP_UID" envsubst | kubectl apply -f- --validate=false ;

        volumeMounts:
        - name: globals-manifests
          mountPath: /data/globals/
      volumes:
      - name: globals-manifests
        configMap:
          name: "${name}-dash-globals-manifests"

  backoffLimit: 3
