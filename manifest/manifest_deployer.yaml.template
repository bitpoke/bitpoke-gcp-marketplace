apiVersion: v1
data:
  orc-topology.cnf: |
    [client]
    user = {{ .Env.ORC_TOPOLOGY_USER }}
    password = {{ .Env.ORC_TOPOLOGY_PASSWORD }}
  orchestrator.conf.json: |-
    {
      "ApplyMySQLPromotionAfterMasterFailover": false,
      "BackendDB": "sqlite",
      "Debug": false,
      "DetachLostReplicasAfterMasterFailover": true,
      "DetectClusterAliasQuery": "SELECT CONCAT(SUBSTRING(@@hostname, 1, LENGTH(@@hostname) - 1 - LENGTH(SUBSTRING_INDEX(@@hostname,'-',-2))),'.',SUBSTRING_INDEX(@@report_host,'.',-1))",
      "DetectInstanceAliasQuery": "SELECT @@hostname",
      "DiscoverByShowSlaveHosts": false,
      "FailMasterPromotionIfSQLThreadNotUpToDate": true,
      "HTTPAdvertise": "http://{{ .Env.HOSTNAME }}-svc:80",
      "HostnameResolveMethod": "none",
      "InstancePollSeconds": 5,
      "ListenAddress": ":3000",
      "MasterFailoverDetachReplicaMasterHost": true,
      "MySQLHostnameResolveMethod": "@@report_host",
      "MySQLTopologyCredentialsConfigFile": "/etc/orchestrator/orc-topology.cnf",
      "OnFailureDetectionProcesses": [
        "/usr/local/bin/orc-helper event -w '{failureClusterAlias}' 'OrcFailureDetection' 'Failure: {failureType}, failed host: {failedHost}, lost replcas: {lostReplicas}' || true",
        "/usr/local/bin/orc-helper failover-in-progress '{failureClusterAlias}' '{failureDescription}' || true"
      ],
      "PostIntermediateMasterFailoverProcesses": [
        "/usr/local/bin/orc-helper event '{failureClusterAlias}' 'OrcPostIntermediateMasterFailover' 'Failure type: {failureType}, failed hosts: {failedHost}, slaves: {countSlaves}' || true"
      ],
      "PostMasterFailoverProcesses": [
        "/usr/local/bin/orc-helper event '{failureClusterAlias}' 'OrcPostMasterFailover' 'Failure type: {failureType}, new master: {successorHost}, slaves: {slaveHosts}' || true"
      ],
      "PostUnsuccessfulFailoverProcesses": [
        "/usr/local/bin/orc-helper event -w '{failureClusterAlias}' 'OrcPostUnsuccessfulFailover' 'Failure: {failureType}, failed host: {failedHost} with {countSlaves} slaves' || true"
      ],
      "PreFailoverProcesses": [
        "/usr/local/bin/orc-helper failover-in-progress '{failureClusterAlias}' '{failureDescription}' || true"
      ],
      "ProcessesShellCommand": "sh",
      "RaftAdvertise": "{{ .Env.HOSTNAME }}-svc",
      "RaftBind": "{{ .Env.HOSTNAME }}",
      "RaftDataDir": "/var/lib/orchestrator",
      "RaftEnabled": true,
      "RaftNodes": [],
      "RecoverIntermediateMasterClusterFilters": [
        ".*"
      ],
      "RecoverMasterClusterFilters": [
        ".*"
      ],
      "RecoveryIgnoreHostnameFilters": [],
      "RecoveryPeriodBlockSeconds": 300,
      "RemoveTextFromHostnameDisplay": ":3306",
      "SQLite3DataFile": "/var/lib/orchestrator/orc.db",
      "SlaveLagQuery": "SELECT TIMESTAMPDIFF(SECOND,ts,NOW()) as drift FROM sys_operator.heartbeat ORDER BY drift ASC LIMIT 1",
      "UnseenInstanceForgetHours": 1
    }
kind: ConfigMap
metadata:
  labels:
    app: mysql-operator
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: mysql-operator-0.3.3
    heritage: Tiller
    release: ${name}
  name: ${name}-mysql-operator-orc
---
apiVersion: v1
data:
  add-headers: ${namespace}/${name}-nginx-ingress-custom-add-headers
  custom-http-errors: 502,503,504
  hsts-preload: "true"
kind: ConfigMap
metadata:
  labels:
    app: nginx-ingress
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: nginx-ingress-1.24.3
    component: controller
    heritage: Tiller
    release: ${name}
  name: ${name}-nginx-ingress-controller
---
apiVersion: v1
data:
  server: nginx
kind: ConfigMap
metadata:
  labels:
    app: nginx-ingress
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: nginx-ingress-1.24.3
    component: controller
    heritage: Tiller
    release: ${name}
  name: ${name}-nginx-ingress-custom-add-headers
---
apiVersion: v1
data:
  CLIENT_ID: $dashboardOIDCClientIDEncoded
  CLIENT_SECRET: $dashboardOIDCSecretEncoded
  ISSUER: $dashboardOIDCIssuerEncoded
kind: Secret
metadata:
  labels:
    app: dashboard
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: dashboard-0.1.0_master
    heritage: Tiller
    release: ${name}
  name: ${name}-dashboard-oidc
type: Opaque
---
apiVersion: v1
data:
  DSN: ""
kind: Secret
metadata:
  labels:
    app: dashboard
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: dashboard-0.1.0_master
    heritage: Tiller
    release: ${name}
  name: ${name}-dashboard-sentry
type: Opaque
---
apiVersion: v1
data:
  TOPOLOGY_PASSWORD: $mysqlOrchestratorPassword
  TOPOLOGY_USER: b3JjaGVzdHJhdG9y
kind: Secret
metadata:
  labels:
    app: mysql-operator
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: mysql-operator-0.3.3
    heritage: Tiller
    release: ${name}
  name: ${name}-mysql-operator-orc
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: cert-manager
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/managed-by: Tiller
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    helm.sh/chart: cert-manager-v0.10.1
  name: ${name}-cert-manager
  namespace: ${namespace}
spec:
  ports:
  - port: 9402
    protocol: TCP
    targetPort: 9402
  selector:
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: webhook
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/managed-by: Tiller
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    helm.sh/chart: cert-manager-v0.10.1
  name: ${name}-cert-manager-webhook
  namespace: ${namespace}
spec:
  ports:
  - name: https
    port: 443
    targetPort: 6443
  selector:
    app: webhook
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/managed-by: Tiller
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dashboard
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: dashboard-0.1.0_master
    heritage: Tiller
    release: ${name}
  name: ${name}-dashboard-apiserver
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: http
  - name: grpc
    port: 9000
    protocol: TCP
    targetPort: grpc
  selector:
    app: dashboard
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    component: apiserver
    release: ${name}
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: dashboard
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: dashboard-0.1.0_master
    heritage: Tiller
    release: ${name}
  name: ${name}-dashboard-webhook
spec:
  ports:
  - name: http
    port: 443
    protocol: TCP
    targetPort: 4433
  selector:
    app: dashboard
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    component: controller
    release: ${name}
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: mysql-operator
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: mysql-operator-0.3.3
    heritage: Tiller
    release: ${name}
  name: ${name}-mysql-operator
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 3000
  selector:
    app: mysql-operator
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    service.alpha.kubernetes.io/tolerate-unready-endpoints: "true"
  labels:
    app: ${name}-mysql-operator
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: mysql-operator-0.3.3
    heritage: Tiller
    release: ${name}
  name: ${name}-mysql-operator-0-svc
spec:
  ports:
  - name: web
    port: 80
    targetPort: 3000
  - name: raft
    port: 10008
    targetPort: 10008
  selector:
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    statefulset.kubernetes.io/pod-name: ${name}-mysql-operator-0
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: nginx-ingress
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: nginx-ingress-1.24.3
    component: controller
    heritage: Tiller
    release: ${name}
  name: ${name}-nginx-ingress-controller
spec:
  clusterIP: ""
  loadBalancerIP: $dashboardIP
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: http
  - name: https
    port: 443
    protocol: TCP
    targetPort: https
  selector:
    app: nginx-ingress
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    component: controller
    release: ${name}
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: nginx-ingress
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: nginx-ingress-1.24.3
    component: default-backend
    heritage: Tiller
    release: ${name}
  name: ${name}-nginx-ingress-default-backend
spec:
  clusterIP: ""
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: http
  selector:
    app: nginx-ingress
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    component: default-backend
    release: ${name}
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: cert-manager
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/managed-by: Tiller
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    helm.sh/chart: cert-manager-v0.10.1
  name: ${name}-cert-manager
  namespace: ${namespace}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cert-manager
      app.kubernetes.io/instance: ${name}
      app.kubernetes.io/managed-by: Tiller
      app.kubernetes.io/name: presslabs-dashboard
      app.kubernetes.io/version: 0.0.1
  template:
    metadata:
      annotations:
        prometheus.io/path: /metrics
        prometheus.io/port: "9402"
        prometheus.io/scrape: "true"
      labels:
        app: cert-manager
        app.kubernetes.io/instance: ${name}
        app.kubernetes.io/managed-by: Tiller
        app.kubernetes.io/name: presslabs-dashboard
        app.kubernetes.io/version: 0.0.1
        helm.sh/chart: cert-manager-v0.10.1
    spec:
      containers:
      - args:
        - --v=2
        - --cluster-resource-namespace=$(POD_NAMESPACE)
        - --leader-election-namespace=$(POD_NAMESPACE)
        - --acme-http01-solver-image=$certAcmeSolverImage
        - --webhook-namespace=$(POD_NAMESPACE)
        - --webhook-ca-secret=${name}-cert-manager-webhook-ca
        - --webhook-serving-secret=${name}-cert-manager-webhook-tls
        - --webhook-dns-names=${name}-cert-manager-webhook,${name}-cert-manager-webhook.${namespace},${name}-cert-manager-webhook.${namespace}.svc
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        image: $certManagerImageRegistry:$certManagerImageTag
        imagePullPolicy: IfNotPresent
        name: cert-manager
        ports:
        - containerPort: 9402
        resources: {}
      serviceAccountName: $serviceAccount
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: cainjector
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/managed-by: Tiller
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    helm.sh/chart: cainjector-v0.10.1
  name: ${name}-cert-manager-cainjector
  namespace: ${namespace}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cainjector
      app.kubernetes.io/instance: ${name}
      app.kubernetes.io/managed-by: Tiller
      app.kubernetes.io/name: presslabs-dashboard
      app.kubernetes.io/version: 0.0.1
  template:
    metadata:
      annotations: null
      labels:
        app: cainjector
        app.kubernetes.io/instance: ${name}
        app.kubernetes.io/managed-by: Tiller
        app.kubernetes.io/name: presslabs-dashboard
        app.kubernetes.io/version: 0.0.1
        helm.sh/chart: cainjector-v0.10.1
    spec:
      containers:
      - args:
        - --v=2
        - --leader-election-namespace=$(POD_NAMESPACE)
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        image: $certCAinjectorImageRegistry:$certCAinjectorImageTag
        imagePullPolicy: IfNotPresent
        name: cainjector
        resources: {}
      serviceAccountName: $serviceAccount
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: webhook
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/managed-by: Tiller
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    helm.sh/chart: cert-manager-v0.10.1
  name: ${name}-cert-manager-webhook
  namespace: ${namespace}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: webhook
      app.kubernetes.io/instance: ${name}
      app.kubernetes.io/managed-by: Tiller
      app.kubernetes.io/name: presslabs-dashboard
      app.kubernetes.io/version: 0.0.1
  template:
    metadata:
      annotations: null
      labels:
        app: webhook
        app.kubernetes.io/instance: ${name}
        app.kubernetes.io/managed-by: Tiller
        app.kubernetes.io/name: presslabs-dashboard
        app.kubernetes.io/version: 0.0.1
        helm.sh/chart: cert-manager-v0.10.1
    spec:
      containers:
      - args:
        - --v=2
        - --secure-port=6443
        - --tls-cert-file=/certs/tls.crt
        - --tls-private-key-file=/certs/tls.key
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        image: $certWebhookImageRegistry:$certWebhookImageTag
        imagePullPolicy: IfNotPresent
        name: cert-manager
        resources: {}
        volumeMounts:
        - mountPath: /certs
          name: certs
      serviceAccountName: $serviceAccount
      volumes:
      - name: certs
        secret:
          secretName: ${name}-cert-manager-webhook-tls
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: dashboard
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: dashboard-0.1.0_master
    component: apiserver
    heritage: Tiller
    release: ${name}
  name: ${name}-dashboard-apiserver
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dashboard
      app.kubernetes.io/instance: ${name}
      app.kubernetes.io/name: presslabs-dashboard
      app.kubernetes.io/version: 0.0.1
      component: apiserver
      release: ${name}
  template:
    metadata:
      annotations:
        checksum/oidc-config: f2a683a6393e8db92df3de75ad77b9966d88456c084c28a2fdced664a7786efa
      labels:
        app: dashboard
        app.kubernetes.io/instance: ${name}
        app.kubernetes.io/name: presslabs-dashboard
        app.kubernetes.io/version: 0.0.1
        component: apiserver
        release: ${name}
    spec:
      containers:
      - args:
        - apiserver
        - --http-addr=:8080
        - --grpc-addr=:9000
        - --base-url=//$dashboardDomain
        env:
        - name: DASHBOARD_SUPERADMIN_EMAILS
          value: ${dashboardAdminEmails}
        envFrom:
        - prefix: OIDC_
          secretRef:
            name: ${name}-dashboard-oidc
        - prefix: SENTRY_
          secretRef:
            name: ${name}-dashboard-sentry
        image: $dashboardImage
        imagePullPolicy: IfNotPresent
        name: apiserver
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        - containerPort: 9000
          name: grpc
          protocol: TCP
        resources: null
      serviceAccount: $serviceAccount
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: dashboard
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: dashboard-0.1.0_master
    component: controller
    heritage: Tiller
    release: ${name}
  name: ${name}-dashboard-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dashboard
      app.kubernetes.io/instance: ${name}
      app.kubernetes.io/name: presslabs-dashboard
      app.kubernetes.io/version: 0.0.1
      component: controller
      release: ${name}
  template:
    metadata:
      annotations:
        checksum/config: 1bbf4d5a3a2fc39f145b3c7dbb12d25827e8a33db91b3891cca07c4653a7a2a4
      labels:
        app: dashboard
        app.kubernetes.io/instance: ${name}
        app.kubernetes.io/name: presslabs-dashboard
        app.kubernetes.io/version: 0.0.1
        component: controller
        release: ${name}
    spec:
      containers:
      - args:
        - controller-manager
        - --webhook-port=4433
        - --webhook-cert-dir=/tmp/${name}-dashboard-webhook-cert-dir
        - --webhook-service-name=${name}-dashboard-webhook
        - --prometheus-operator-enabled=false
        - --site-certificate-issuer=${name}-default
        env:
        - name: AGENT_ENCODED_KEY
          valueFrom:
            secretKeyRef:
              key: reporting-key
              name: $reportingSecret
        - name: AGENT_CONSUMER_ID
          valueFrom:
            secretKeyRef:
              key: consumer-id
              name: $reportingSecret
        - name: AGENT_SERVICE_NAME
          value: presslabs-dashboard.mp-press-labs-public.appspot.com
        image: $dashboardImage
        imagePullPolicy: IfNotPresent
        name: controller
        ports:
        - containerPort: 4433
          name: webhook
        volumeMounts:
        - mountPath: /tmp/${name}-dashboard-webhook-cert-dir
          name: webhook-certs
      serviceAccount: $serviceAccount
      volumes:
      - name: webhook-certs
        secret:
          items:
          - key: tls.crt
            path: cert.pem
          - key: tls.key
            path: key.pem
          secretName: ${name}-dashboard-webhook
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx-ingress
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: nginx-ingress-1.24.3
    component: controller
    heritage: Tiller
    release: ${name}
  name: ${name}-nginx-ingress-controller
spec:
  minReadySeconds: 0
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: nginx-ingress
      app.kubernetes.io/instance: ${name}
      app.kubernetes.io/name: presslabs-dashboard
      app.kubernetes.io/version: 0.0.1
      release: ${name}
  strategy: {}
  template:
    metadata:
      labels:
        app: nginx-ingress
        app.kubernetes.io/instance: ${name}
        app.kubernetes.io/name: presslabs-dashboard
        app.kubernetes.io/version: 0.0.1
        component: controller
        release: ${name}
    spec:
      containers:
      - args:
        - /nginx-ingress-controller
        - --default-backend-service=${namespace}/${name}-nginx-ingress-default-backend
        - --publish-service=${namespace}/${name}-nginx-ingress-controller
        - --election-id=ingress-controller-leader
        - --ingress-class=presslabs-stack
        - --configmap=${namespace}/${name}-nginx-ingress-controller
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        image: $ingressImageRegistry:$ingressImageTag
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz
            port: 10254
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        name: nginx-ingress-controller
        ports:
        - containerPort: 80
          name: http
          protocol: TCP
        - containerPort: 443
          name: https
          protocol: TCP
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz
            port: 10254
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        resources: {}
        securityContext:
          allowPrivilegeEscalation: true
          capabilities:
            add:
            - NET_BIND_SERVICE
            drop:
            - ALL
          runAsUser: 33
      dnsPolicy: ClusterFirst
      hostNetwork: false
      serviceAccountName: $serviceAccount
      terminationGracePeriodSeconds: 60
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx-ingress
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: nginx-ingress-1.24.3
    component: default-backend
    heritage: Tiller
    release: ${name}
  name: ${name}-nginx-ingress-default-backend
spec:
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: nginx-ingress
      app.kubernetes.io/instance: ${name}
      app.kubernetes.io/name: presslabs-dashboard
      app.kubernetes.io/version: 0.0.1
      release: ${name}
  template:
    metadata:
      labels:
        app: nginx-ingress
        app.kubernetes.io/instance: ${name}
        app.kubernetes.io/name: presslabs-dashboard
        app.kubernetes.io/version: 0.0.1
        component: default-backend
        release: ${name}
    spec:
      containers:
      - args: null
        image: $ingressDefaultBackendImageRegistry:$ingressDefaultBackendImageTag
        imagePullPolicy: Always
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
        name: nginx-ingress-default-backend
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        readinessProbe:
          failureThreshold: 6
          httpGet:
            path: /healthz
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 0
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 5
        resources: {}
        securityContext:
          runAsUser: 65534
      serviceAccountName: $serviceAccount
      terminationGracePeriodSeconds: 60
---
apiVersion: apps/v1beta2
kind: Deployment
metadata:
  labels:
    app: wordpress-operator
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: wordpress-operator-v0.6.3
    heritage: Tiller
    release: ${name}
  name: ${name}-wordpress-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wordpress-operator
      app.kubernetes.io/instance: ${name}
      app.kubernetes.io/name: presslabs-dashboard
      app.kubernetes.io/version: 0.0.1
      release: ${name}
  template:
    metadata:
      labels:
        app: wordpress-operator
        app.kubernetes.io/instance: ${name}
        app.kubernetes.io/name: presslabs-dashboard
        app.kubernetes.io/version: 0.0.1
        release: ${name}
    spec:
      containers:
      - args:
        - --ingress-class=presslabs-stack
        image: $wordpressOperatorImage
        imagePullPolicy: IfNotPresent
        name: wordpress-operator
        resources: {}
      serviceAccount: $serviceAccount
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: mysql-operator
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: mysql-operator-0.3.3
    heritage: Tiller
    release: ${name}
  name: ${name}-mysql-operator
spec:
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      app: mysql-operator
      app.kubernetes.io/instance: ${name}
      app.kubernetes.io/name: presslabs-dashboard
      app.kubernetes.io/version: 0.0.1
      release: ${name}
  serviceName: ${name}-mysql-operator-orc
  template:
    metadata:
      annotations:
        checksum/config: fcf882e5a77176c667f10bc86695f850d1db8888897a59544a1a9877110cc5c8
        checksum/secret: f0cb7a1824aca94a0aff5019f2cc510593ed6c83d31f346dff8373d08b54f664
      labels:
        app: mysql-operator
        app.kubernetes.io/instance: ${name}
        app.kubernetes.io/name: presslabs-dashboard
        app.kubernetes.io/version: 0.0.1
        release: ${name}
    spec:
      affinity: null
      containers:
      - args:
        - --leader-election-namespace=${namespace}
        - --orchestrator-uri=http://127.0.0.1:3000/api
        - --sidecar-image=quay.io/presslabs/mysql-operator-sidecar:0.3.3
        - --leader-election-id=mysql-operator-leader-election
        env:
        - name: ORC_TOPOLOGY_USER
          valueFrom:
            secretKeyRef:
              key: TOPOLOGY_USER
              name: ${name}-mysql-operator-orc
        - name: ORC_TOPOLOGY_PASSWORD
          valueFrom:
            secretKeyRef:
              key: TOPOLOGY_PASSWORD
              name: ${name}-mysql-operator-orc
        image: $mysqlControllerImage
        imagePullPolicy: IfNotPresent
        name: operator
        resources: {}
      - env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        envFrom:
        - prefix: ORC_
          secretRef:
            name: ${name}-mysql-operator-orc
        image: $mysqlOrchestratorImage
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /api/lb-check
            port: 3000
          initialDelaySeconds: 200
          timeoutSeconds: 10
        name: orchestrator
        ports:
        - containerPort: 3000
          name: web
          protocol: TCP
        - containerPort: 10008
          name: raft
          protocol: TCP
        readinessProbe:
          httpGet:
            path: /api/raft-health
            port: 3000
          timeoutSeconds: 10
        resources: null
        volumeMounts:
        - mountPath: /var/lib/orchestrator/
          name: data
        - mountPath: /templates/
          name: config
      securityContext:
        fsGroup: 777
      serviceAccountName: $serviceAccount
      volumes:
      - configMap:
          name: ${name}-mysql-operator-orc
        name: config
  volumeClaimTemplates:
  - metadata:
      labels:
        app.kubernetes.io/instance: ${name}
        app.kubernetes.io/name: presslabs-dashboard
        app.kubernetes.io/version: 0.0.1
      name: data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
---
apiVersion: app.k8s.io/v1beta1
kind: Application
metadata:
  annotations:
    kubernetes-engine.cloud.google.com/icon: data:image/png;base64,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
  labels:
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
  name: ${name}
spec:
  componentKinds:
  - group: v1
    kind: Secret
  - group: v1
    kind: ConfigMap
  - group: v1
    kind: PersistentVolumeClaim
  - group: v1
    kind: Service
  - group: apps
    kind: Deployment
  - group: apps
    kind: StatefulSet
  - group: batch
    kind: Job
  - group: batch
    kind: CronJob
  - group: extensions/v1beta1
    kind: Ingress
  descriptor:
    description: |
      Presslabs Dashboard is the first cloud-native platform to manage and scale WordPress, using
      Kubernetes. It is built as an opinionated implementation of the Presslabs Stack, a collection
      of open source low-level building blocks for WordPress infrastructure.
    links:
    - description: Presslabs Dashboard documentation
      url: https://www.presslabs.com/docs/dashboard
    - description: Presslabs Stack
      url: https://presslabs.com/stack
    maintainers:
    - name: Presslabs
      url: https://presslabs.com/stack
    notes: |-
      Create your organization, group sites in projects and launch with a click new sites that scale
      up and down automatically as needed. Give your team access and start working on your very own
      cloud-native hosting platform!

      ## How to

      Update super admin emails list:

      ```
      export DASHBOARD_SUPERADMIN_EMAILS=admin1@example.com,admin2@example.com
      kubectl -n ${namespace} patch deployment ${name}-dashboard-apiserver '{"spec":{"template":{"spec":{"containers":[{"name":"apiserver","env":[{"name":"DASHBOARD_SUPERADMIN_EMAILS","value":"'"$DASHBOARD_SUPERADMIN_EMAILS"'"}]}]}}}}'
      ```
    type: Presslabs Stack
    version: v0.5.1
  info:
  - name: Ingress IP
    type: Reference
    valueFrom:
      serviceRef:
        name: ${name}-nginx-ingress-controller
  - name: Domain Name
    value: https://$dashboardDomain
  - name: Let's Encrypt email
    value: $letsEncryptEmail
  - name: Let's Encrypt URL
    value: $letsEncryptServer
  - name: Auth0 Client ID
    type: Reference
    valueFrom:
      secretKeyRef:
        key: CLIENT_ID
        name: ${name}-dashboard-oidc
  - name: Auth0 Client Secret
    type: Reference
    valueFrom:
      secretKeyRef:
        key: CLIENT_SECRET
        name: ${name}-dashboard-oidc
  - name: Auth0 Issuer URL
    type: Reference
    valueFrom:
      secretKeyRef:
        key: ISSUER
        name: ${name}-dashboard-oidc
  selector:
    matchLabels:
      app.kubernetes.io/instance: ${name}
      app.kubernetes.io/name: presslabs-dashboard
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    certmanager.k8s.io/acme-challenge-type: http01
    certmanager.k8s.io/cluster-issuer: ${name}-default
    kubernetes.io/ingress.class: presslabs-stack
  labels:
    app: dashboard
    app.kubernetes.io/instance: ${name}
    app.kubernetes.io/name: presslabs-dashboard
    app.kubernetes.io/version: 0.0.1
    chart: dashboard-0.1.0_master
    heritage: Tiller
    release: ${name}
  name: ${name}-dashboard-apiserver
spec:
  rules:
  - host: $dashboardDomain
    http:
      paths:
      - backend:
          serviceName: ${name}-dashboard-apiserver
          servicePort: http
        path: /
  tls:
  - hosts:
    - $dashboardDomain
    secretName: ${name}-dashboard-tls
