apiVersion: admissionregistration.k8s.io/v1beta1
kind: ValidatingWebhookConfiguration
metadata:
  labels:
    app: '{{ include "dashboard.name" . }}'
    chart: '{{ include "dashboard.chart" . }}'
    heritage: '{{ .Release.Service }}'
    release: '{{ .Release.Name }}'
  name: '{{ include "dashboard.fullname" . }}'
  annotations:
    certmanager.k8s.io/inject-ca-from: {{ .Release.Namespace }}/{{ include "dashboard.webhook.rootCACertificate" . }}
webhooks:
# NOTE: make sure to keep it in sync with config/webhook/webhook.yaml
- clientConfig:
    service:
      name: '{{ include "dashboard.webhook.serviceName" . }}'
      namespace: '{{ .Release.Namespace }}'
      path: /validating-create-organization
  failurePolicy: Fail
  name: validating-create-organization.presslabs.com
  namespaceSelector:
    matchExpressions:
    - key: control-plane
      operator: DoesNotExist
  rules:
  - apiGroups:
    - ""
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - namespaces
- clientConfig:
    service:
      name: '{{ include "dashboard.webhook.serviceName" . }}'
      namespace: '{{ .Release.Namespace }}'
      path: /validating-create-project
  failurePolicy: Fail
  name: validating-create-project.presslabs.com
  namespaceSelector:
    matchExpressions:
    - key: control-plane
      operator: DoesNotExist
  rules:
  - apiGroups:
    - ""
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - namespaces
- clientConfig:
    service:
      name: '{{ include "dashboard.webhook.serviceName" . }}'
      namespace: '{{ .Release.Namespace }}'
      path: /validating-create-site
  failurePolicy: Fail
  name: validating-create-site.presslabs.com
  namespaceSelector:
    matchExpressions:
    - key: control-plane
      operator: DoesNotExist
  rules:
  - apiGroups:
    - wordpress.presslabs.org
    apiVersions:
    - v1alpha1
    operations:
    - CREATE
    - UPDATE
    resources:
    - wordpresses
